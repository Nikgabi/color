#!/bin/bash

# === CONFIGURATION ===
WEBROOT="/var/www/html/color"
LOGFILE="/var/log/malware_cleanup.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$DATE] Starting malware scan..." >> "$LOGFILE"

# === STEP 1: Find infected files ===
infected_files=$(grep -rl --exclude-dir={.git,vendor,node_modules} "leostop.com" "$WEBROOT")

# === STEP 2: Clean infected files ===
for file in $infected_files; do
    echo "[$DATE] Cleaning: $file" >> "$LOGFILE"
    cp "$file" "$file.bak"
    sed -i '/leostop.com/d' "$file"
done

# === STEP 3: Lock critical JS files ===
protected_js="$WEBROOT/js/jquery-3.7.1.min.js"
if [ -f "$protected_js" ]; then
    chattr +i "$protected_js"
    echo "[$DATE] Locked: $protected_js" >> "$LOGFILE"
fi

echo "[$DATE] Malware scan and cleanup completed." >> "$LOGFILE"
